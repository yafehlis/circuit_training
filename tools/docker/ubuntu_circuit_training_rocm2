# Run the following commands in order:
#
# docker build --tag circuit_training:core -f tools/docker/ubuntu_circuit_training tools/docker/
#
# The docker can also be built with tf-agents-nightly, which can be useful if
# Circuit Training head is using APIs not yet in tf-agents stable.
#
# docker build --build-arg tf_agents_version=tf-agents-nightly[reverb] \
#   --tag circuit_training:core -f tools/docker/ubuntu_circuit_training tools/docker/
#
# Smoke test the docker
# docker run -it --rm -v $(pwd):/workspace --workdir /workspace circuit_training:core bash
# python3 -m circuit_training.environment.environment_test
#
# For GPUs. devel version is needed to support xla.
# docker build --build-arg base_image=nvidia/cuda:11.4.2-cudnn8-devel-ubuntu20.04 \
#   --tag circuit_training:core -f tools/docker/ubuntu_circuit_training tools/docker/
ARG base_image="rocm/tensorflow"

FROM $base_image

LABEL maintainer="tobyboyd@google.com"

# Supports setting up a single version of python.
ARG python_version="python3"
ARG tf_agents_version="tf-agents[reverb]"
ARG dreamplace_version="dreamplace_python3.9.tar.gz"
ARG APT_COMMAND="apt-get -o Acquire::Retries=3 -y"


# Stops tzdata from asking about timezones and blocking install on user input.
ARG DEBIAN_FRONTEND=noninteractive
ENV TZ=America/Los_Angeles

# Installs basics including add-apt.
RUN ${APT_COMMAND} update && ${APT_COMMAND} install -y --no-install-recommends \
        software-properties-common \
        curl \
        tmux \
	bc \
	htop \
        vim \
        less

# Adds repository to pull versions of python from.
#RUN add-apt-repository ppa:deadsnakes/ppa

# Installs desired python version if not aready installed and then cleans up apt.
RUN ${APT_COMMAND} update && ${APT_COMMAND} install -y --no-install-recommends \
        $python_version-dev \
        $python_version-distutils \
        && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Downloads the placement cost utility binary nto /usr/local/bin.
RUN curl https://storage.googleapis.com/rl-infra-public/circuit-training/placement_cost/plc_wrapper_main \
     -o  /usr/local/bin/plc_wrapper_main

RUN chmod 555 /usr/local/bin/plc_wrapper_main

# RUN curl -O https://bootstrap.pypa.io/get-pip.py

RUN $python_version get-pip.py

# Installs TF-Agents and Tensorflow along with tox and pytest to help verify the
# container via unit tests.

RUN $python_version -mpip --no-cache-dir install sortedcontainers tox pytest
RUN $python_version -mpip --no-cache-dir install --no-deps $tf_agents_version 
RUN $python_version -mpip install gin-config
RUN $python_version -mpip install cloudpickle>=1.3
RUN $python_version -mpip install gym==0.23.0
RUN $python_version -mpip install pillow
RUN $python_version -mpip install pygame==2.1.3
RUN $python_version -mpip install tensorflow-probability~=0.19.0
RUN $python_version -mpip install dm-reverb

# Installs system dependencies needed by DREAMPlace.
RUN apt-get update \
        && apt-get install -y \
            wget \
            flex \
            libcairo2-dev 
RUN apt-get install -y aptitude
RUN aptitude install -y libboost-all-dev

# Installs specific versions of packages requested by DREAMPlace requirements.txt
RUN $python_version -mpip install pyunpack>=0.1.2 \
        patool>=1.12 \
        matplotlib>=2.2.2 \
        cairocffi>=0.9.0 \
        pkgconfig>=1.4.0 \
        setuptools>=39.1.0 \
        scipy>=1.1.0 \
        numpy==1.23.1 \
        #torch>=1.6.0 \
        shapely>=1.7.0

RUN pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/rocm5.4.2

# Installs specific versions of packages that need pinned various reasons.
RUN $python_version -mpip install numpy==1.23.5 # Required by tensorflow until fixed ~TF 2.12+

RUN mkdir -p /dreamplace
COPY ./dreamplace_${python_version}.tar.gz /dreamplace/dreamplace.tar.gz
RUN tar xzf /dreamplace/dreamplace.tar.gz -C /dreamplace/

# Sets the python path so we can find Placer with `import dreamplace.Placer`
# This also needs to put all of DREAMPlace at the root because DREAMPlace python
# is not setup like a package with imports like `dreamplace.Param`.
ENV PYTHONPATH "${PYTHONPATH}:/dreamplace:/dreamplace/dreamplace"

CMD ["/bin/bash"]
